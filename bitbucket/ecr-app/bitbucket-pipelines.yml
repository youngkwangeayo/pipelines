#  ==============  ë ˆí¬ì§€í† ë¦¬ í™˜ê²½ ë³€ìˆ˜  ==============
#   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,  AWS_DEFAULT_REGION       # CLI
#   AWS_ECR_REPO, AWS_ECR_NAME                                          # ECR ë¼ì´ë¸Œ
#   AWS_ECR_REPO_DEV, AWS_ECR_NAME_DEV                                  # ECR ë°ë¸Œ
#   AWS_TASK_DEFINITION, AWS_ECS_CLUSTER, AWS_ECS_SERVICE               # ECS ë¼ì´ë¸Œ
#   AWS_TASK_DEFINITION_DEV, AWS_ECS_CLUSTER_DEV, AWS_ECS_SERVICE_DEV   # ECS ë°ë¸Œ
# =================================================
#  ë‚´ìš©
# =================================================
image: atlassian/default-image:2

pipelines:
  tags:
    '*.*.*-dev-*':
      - step:
          name: ðŸ—ï¸ Build & Push Image to ECR (DEV)
          services:
            - docker
          script:
            # Docker ì´ë¯¸ì§€ ë¹Œë“œ
            - TARGET_VERSION=$BITBUCKET_TAG
            - docker build -t $AWS_ECR_NAME_DEV:$TARGET_VERSION -t $AWS_ECR_NAME_DEV .
            # ECRì— REPO íƒœê·¸ ì§€ì •
            - docker tag $AWS_ECR_NAME_DEV:$TARGET_VERSION $AWS_ECR_REPO_DEV/$AWS_ECR_NAME_DEV:$TARGET_VERSION
            - docker tag $AWS_ECR_NAME_DEV:$TARGET_VERSION $AWS_ECR_REPO_DEV/$AWS_ECR_NAME_DEV:latest
            # ECRì— í‘¸ì‹œ
            - pipe: atlassian/aws-ecr-push-image:2.6.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                IMAGE_NAME: $AWS_ECR_NAME_DEV
                TAGS: "$TARGET_VERSION latest"
      - parallel:
        - step:
            name: ðŸš€ Deploy to ECS (DEV)
            image: amazon/aws-cli:2.30.3
            script:
              # ë ˆí¬í™˜ê²½ë³€ìˆ˜ export ë° dev ìž¬í• ë‹¹ _ ìŠ¤í¬ë¦½íŠ¸ ìž¬ì‚¬ìš© ìœ„í•´
              - export TARGET_VERSION=$BITBUCKET_TAG
              - export AWS_TASK_DEFINITION=$AWS_TASK_DEFINITION_DEV
              - export AWS_ECS_CLUSTER=$AWS_ECS_CLUSTER_DEV
              - export AWS_ECS_SERVICE=$AWS_ECS_SERVICE_DEV
              - export AWS_ECR_REPO=$AWS_ECR_REPO_DEV
              - export AWS_ECR_NAME=$AWS_ECR_NAME_DEV

              # TODO URL ì¤‘ë³µ ë®ì–´ì“°ê¸°. ì¶”í›„ terraform+ecs í™˜ê²½ìœ¼ë¡œ í™•ì •ë˜ë©´ ê·¸ë–„ ë¹¼ê¸°
              - echo "CMS_URL=https://dev-cms.nextpay.co.kr" >> .env.dev
              
              - chmod +x ./infra/convert-env-to-awsjson.sh ./infra/pipe-task-reversion.sh

              # Reversion & deploy
              - source ./infra/pipe-task-reversion.sh ./infra/convert-env-to-awsjson.sh .env.dev

              - aws ecs update-service --cluster $AWS_ECS_CLUSTER --service $AWS_ECS_SERVICE --task-definition $AWS_TASK_DEFINITION:$NEW_REVISION --force-new-deployment
              - echo "ECS await provisioning..."
              
              - aws ecs wait services-stable --cluster $AWS_ECS_CLUSTER --services $AWS_ECS_SERVICE
              - echo "âœ… ECS deployment completed successfully!"
        - step:
            name: ðŸš€[Cron] Deploy to ECS (DEV)
            image: amazon/aws-cli:2.30.3
            script:
              # ë ˆí¬í™˜ê²½ë³€ìˆ˜ export ë° dev ìž¬í• ë‹¹ _ ìŠ¤í¬ë¦½íŠ¸ ìž¬ì‚¬ìš© ìœ„í•´
              - export TARGET_VERSION=$BITBUCKET_TAG
              - export AWS_TASK_DEFINITION=$AWS_TASK_DEFINITION_DEV-cron
              - export AWS_ECS_SERVICE=$AWS_ECS_SERVICE_DEV-cron
              - export AWS_ECS_CLUSTER=$AWS_ECS_CLUSTER_DEV
              - export AWS_ECR_REPO=$AWS_ECR_REPO_DEV
              - export AWS_ECR_NAME=$AWS_ECR_NAME_DEV

              # TODO URL ì¤‘ë³µ ë®ì–´ì“°ê¸°. ì¶”í›„ terraform+ecs í™˜ê²½ìœ¼ë¡œ í™•ì •ë˜ë©´ ê·¸ë–„ ë¹¼ê¸°
              - echo "CMS_URL=https://dev-cms.nextpay.co.kr" >> .env.dev
              - echo "CRON=ENABLE" >> .env.dev
              
              - chmod +x ./infra/convert-env-to-awsjson.sh ./infra/pipe-task-reversion.sh

              # Reversion & deploy
              - source ./infra/pipe-task-reversion.sh ./infra/convert-env-to-awsjson.sh .env.dev

              - aws ecs update-service --cluster $AWS_ECS_CLUSTER --service $AWS_ECS_SERVICE --task-definition $AWS_TASK_DEFINITION:$NEW_REVISION --force-new-deployment
              - echo "ECS await provisioning..."
              
              - aws ecs wait services-stable --cluster $AWS_ECS_CLUSTER --services $AWS_ECS_SERVICE
              - echo "âœ… ECS deployment completed successfully!"
    '*.*.*':
        - step:
            name: ðŸ—ï¸ Build & Push Image to ECR (PROD)
            services:
              - docker
            script:
              # Docker ì´ë¯¸ì§€ ë¹Œë“œ
              - TARGET_VERSION=$BITBUCKET_TAG
              - docker build -t $AWS_ECR_NAME:$TARGET_VERSION -t $AWS_ECR_NAME .
              # ECRì— REPO íƒœê·¸ ì§€ì •
              - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:$TARGET_VERSION
              - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:latest
              # ECRì— í‘¸ì‹œ
              - pipe: atlassian/aws-ecr-push-image:2.6.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                  IMAGE_NAME: $AWS_ECR_NAME
                  TAGS: "$TARGET_VERSION latest"
        - parallel:
          - step:
              name: ðŸš€ Deploy to ECS (PROD)
              image: amazon/aws-cli:2.30.3
              script:
                - export TARGET_VERSION=$BITBUCKET_TAG
                - chmod +x ./infra/convert-env-to-awsjson.sh ./infra/pipe-task-reversion.sh

                # Reversion & deploy
                - source ./infra/pipe-task-reversion.sh ./infra/convert-env-to-awsjson.sh .env.prod

                - echo "It's not fully complete. Go into AWS console ECS and deploy the relevant revision $NEW_REVISION"
          - step:
              name: ðŸš€[Cron] Deploy to ECS (PROD)
              image: amazon/aws-cli:2.30.3
              script:
                 # ë ˆí¬í™˜ê²½ë³€ìˆ˜ export ë° cron ìž¬í• ë‹¹ _ ìŠ¤í¬ë¦½íŠ¸ ìž¬ì‚¬ìš© ìœ„í•´
                - export AWS_TASK_DEFINITION=$AWS_TASK_DEFINITION-cron
                - export AWS_ECS_SERVICE=$AWS_ECS_SERVICE-cron
                - export TARGET_VERSION=$BITBUCKET_TAG
                
                - echo "CRON=ENABLE" >> .env.prod

                - chmod +x ./infra/convert-env-to-awsjson.sh ./infra/pipe-task-reversion.sh

                # Reversion & deploy
                - source ./infra/pipe-task-reversion.sh ./infra/convert-env-to-awsjson.sh .env.prod

                - echo "It's not fully complete. Go into AWS console ECS and deploy the relevant revision $NEW_REVISION"

                