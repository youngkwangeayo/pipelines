#  ==============  Î†àÌè¨ÏßÄÌÜ†Î¶¨ ÌôòÍ≤Ω Î≥ÄÏàò  ==============
#   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,  AWS_DEFAULT_REGION       # CLI
#   AWS_ECR_REPO, AWS_ECR_NAME                                          # ECR
#   AWS_TASK_DEFINITION, AWS_ECS_CLUSTER, AWS_ECS_SERVICE               # ECS ÎùºÏù¥Î∏å
#   AWS_TASK_DEFINITION_DEV, AWS_ECS_CLUSTER_DEV, AWS_ECS_SERVICE_DEV   # ECS Îç∞Î∏å
# =================================================
#  ÎÇ¥Ïö©
# =================================================
image: atlassian/default-image:2

pipelines:
  tags:
    '*.*.*-dev-*':
      - step:
          name: üèóÔ∏è Build & Push Image to ECR (DEV)
          services:
            - docker
          script:
            # Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
            - TARGET_VERSION=$BITBUCKET_TAG
            - docker build -t $AWS_ECR_NAME:$TARGET_VERSION -t $AWS_ECR_NAME .
            # ECRÏóê REPO ÌÉúÍ∑∏ ÏßÄÏ†ï
            - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:$TARGET_VERSION
            - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:latest
            # ECRÏóê Ìë∏Ïãú
            - pipe: atlassian/aws-ecr-push-image:2.6.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                IMAGE_NAME: $AWS_ECR_NAME
                TAGS: "$TARGET_VERSION latest"

      - step:
          name: üöÄ Deploy to ECS (DEV)
          image: amazon/aws-cli:2.30.3
          script:
            # Î†àÌè¨ÌôòÍ≤ΩÎ≥ÄÏàò export Î∞è dev Ïû¨Ìï†Îãπ _ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïû¨ÏÇ¨Ïö© ÏúÑÌï¥
            - export TARGET_VERSION=$BITBUCKET_TAG
            - export AWS_TASK_DEFINITION=$AWS_TASK_DEFINITION_DEV
            - export AWS_ECS_CLUSTER=$AWS_ECS_CLUSTER_DEV
            - export AWS_ECS_SERVICE=$AWS_ECS_SERVICE_DEV

            - chmod +x ./infra/convert-env-to-awsjson.sh ./infra/pipe-task-reversion.sh

            # Reversion & deploy
            - source ./infra/pipe-task-reversion.sh ./infra/convert-env-to-awsjson.sh .env.dev

            - aws ecs update-service --cluster $AWS_ECS_CLUSTER --service $AWS_ECS_SERVICE --task-definition $AWS_TASK_DEFINITION:$NEW_REVISION --force-new-deployment
            - echo "ECS await provisioning..."
            
            - aws ecs wait services-stable --cluster $AWS_ECS_CLUSTER --services $AWS_ECS_SERVICE
            - echo "‚úÖ ECS deployment completed successfully!"
    '*.*.*':
        - step:
            name: üèóÔ∏è Build & Push Image to ECR (PROD)
            services:
              - docker
            script:
              # Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
              - TARGET_VERSION=$BITBUCKET_TAG
              - docker build -t $AWS_ECR_NAME:$TARGET_VERSION -t $AWS_ECR_NAME .
              # ECRÏóê REPO ÌÉúÍ∑∏ ÏßÄÏ†ï
              - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:$TARGET_VERSION
              - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:latest
              # ECRÏóê Ìë∏Ïãú
              - pipe: atlassian/aws-ecr-push-image:2.6.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                  IMAGE_NAME: $AWS_ECR_NAME
                  TAGS: "$TARGET_VERSION latest"
        - step:
            name: üöÄ Deploy to ECS (PROD)
            image: amazon/aws-cli:2.30.3
            script:
              - export TARGET_VERSION=$BITBUCKET_TAG
              - chmod +x ./infra/convert-env-to-awsjson.sh ./infra/pipe-task-reversion.sh

              # Reversion & deploy
              - source ./infra/pipe-task-reversion.sh ./infra/convert-env-to-awsjson.sh .env.prod

              - echo "It's not fully complete. Go into AWS console ECS and deploy the relevant revision $NEW_REVISION"

              