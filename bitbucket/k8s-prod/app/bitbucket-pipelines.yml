#  ==============  Î†àÌè¨ÏßÄÌÜ†Î¶¨ ÌôòÍ≤Ω Î≥ÄÏàò  ==============
#   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,  AWS_DEFAULT_REGION       # CLI
#   AWS_ECR_REPO, AWS_ECR_NAME                                          # ECR ÎùºÏù¥Î∏å
#   AWS_ECR_REPO_DEV, AWS_ECR_NAME_DEV                                  # ECR Îç∞Î∏å
#   K8S_REPO, K8S_API_TOKEN                                             # K8S ÎùºÏù¥Î∏å, Îç∞Î∏å
# =================================================
#  ÎÇ¥Ïö©
# =================================================
image: atlassian/default-image:2

pipelines:
  tags:
    '*.*.*-dev-*':
      - step:
          name: üèóÔ∏è Build & Push Image to ECR (DEV)
          services:
            - docker
          script:
            # Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
            - docker build -t $AWS_ECR_NAME_DEV:$BITBUCKET_TAG -t $AWS_ECR_NAME_DEV .
            # ECRÏóê REPO ÌÉúÍ∑∏ ÏßÄÏ†ï
            - docker tag $AWS_ECR_NAME_DEV:$BITBUCKET_TAG $AWS_ECR_REPO_DEV/$AWS_ECR_NAME_DEV:$BITBUCKET_TAG
            - docker tag $AWS_ECR_NAME_DEV:$BITBUCKET_TAG $AWS_ECR_REPO_DEV/$AWS_ECR_NAME_DEV:latest
            # ECRÏóê Ìë∏Ïãú
            - pipe: atlassian/aws-ecr-push-image:2.6.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                IMAGE_NAME: $AWS_ECR_NAME_DEV
                TAGS: "$BITBUCKET_TAG latest"
      - parallel:
        - step:
            name: CMS Deploy Trigger k8s pipe (DEV)
            script:
              - |
                curl -sS -D - \
                  -H "Authorization: Bearer $K8S_API_TOKEN" \
                  -H "Content-Type: application/json" \
                  -X POST "https://api.bitbucket.org/2.0/repositories/$K8S_REPO/pipelines/" \
                  -d "{
                    \"target\": {
                      \"type\": \"pipeline_ref_target\",
                      \"ref_type\": \"branch\",
                      \"ref_name\": \"main\",
                      \"selector\": { \"type\": \"custom\", \"pattern\": \"deploy-app\" }
                    },
                    \"variables\": [
                      { \"key\": \"APP_NAME\", \"value\": \"cms\" },
                      { \"key\": \"IMAGE_TAG\", \"value\": \"$BITBUCKET_TAG\" },
                      { \"key\": \"ENV\", \"value\": \"dev\" }
                    ]
                  }"
        - step:
            name: CMS-CRON Deploy Trigger k8s pipe (DEV)
            script:
              - |
                curl -sS -D - \
                  -H "Authorization: Bearer $K8S_API_TOKEN" \
                  -H "Content-Type: application/json" \
                  -X POST "https://api.bitbucket.org/2.0/repositories/$K8S_REPO/pipelines/" \
                  -d "{
                    \"target\": {
                      \"type\": \"pipeline_ref_target\",
                      \"ref_type\": \"branch\",
                      \"ref_name\": \"main\",
                      \"selector\": { \"type\": \"custom\", \"pattern\": \"deploy-app\" }
                    },
                    \"variables\": [
                      { \"key\": \"APP_NAME\", \"value\": \"cms-cron\" },
                      { \"key\": \"IMAGE_TAG\", \"value\": \"$BITBUCKET_TAG\" },
                      { \"key\": \"ENV\", \"value\": \"dev\" }
                    ]
                  }"
    '*.*.*':
        - step:
            name: üèóÔ∏è Build & Push Image to ECR (PROD)
            services:
              - docker
            script:
              # Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
              - docker build -t $AWS_ECR_NAME:$BITBUCKET_TAG -t $AWS_ECR_NAME .
              # ECRÏóê REPO ÌÉúÍ∑∏ ÏßÄÏ†ï
              - docker tag $AWS_ECR_NAME:$BITBUCKET_TAG $AWS_ECR_REPO/$AWS_ECR_NAME:$BITBUCKET_TAG
              - docker tag $AWS_ECR_NAME:$BITBUCKET_TAG $AWS_ECR_REPO/$AWS_ECR_NAME:latest
              # ECRÏóê Ìë∏Ïãú
              - pipe: atlassian/aws-ecr-push-image:2.6.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                  IMAGE_NAME: $AWS_ECR_NAME
                  TAGS: "$BITBUCKET_TAG latest"
        - parallel:
          - step:
              name: CMS Deploy Trigger k8s pipe (PROD)
              script:
                - |
                  curl -sS -D - \
                    -H "Authorization: Bearer $K8S_API_TOKEN" \
                    -H "Content-Type: application/json" \
                    -X POST "https://api.bitbucket.org/2.0/repositories/$K8S_REPO/pipelines/" \
                    -d "{
                      \"target\": {
                        \"type\": \"pipeline_ref_target\",
                        \"ref_type\": \"branch\",
                        \"ref_name\": \"main\",
                        \"selector\": { \"type\": \"custom\", \"pattern\": \"generate-prod\" }
                      },
                      \"variables\": [
                        { \"key\": \"APP_NAME\", \"value\": \"cms\" },
                        { \"key\": \"IMAGE_TAG\", \"value\": \"$BITBUCKET_TAG\" },
                        { \"key\": \"ENV\", \"value\": \"prod\" }
                      ]
                    }"
          - step:
              name: CMS-CRON Deploy Trigger k8s pipe (PROD)
              script:
                - |
                  curl -sS -D - \
                    -H "Authorization: Bearer $K8S_API_TOKEN" \
                    -H "Content-Type: application/json" \
                    -X POST "https://api.bitbucket.org/2.0/repositories/$K8S_REPO/pipelines/" \
                    -d "{
                      \"target\": {
                        \"type\": \"pipeline_ref_target\",
                        \"ref_type\": \"branch\",
                        \"ref_name\": \"main\",
                        \"selector\": { \"type\": \"custom\", \"pattern\": \"generate-prod\" }
                      },
                      \"variables\": [
                        { \"key\": \"APP_NAME\", \"value\": \"cms-cron\" },
                        { \"key\": \"IMAGE_TAG\", \"value\": \"$BITBUCKET_TAG\" },
                        { \"key\": \"ENV\", \"value\": \"prod\" }
                      ]
                    }"